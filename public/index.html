<!DOCTYPE HTML>

<html>

<head>
	<title>Dynamic Rhythm</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<link rel="stylesheet" href="assets/css/main.css" />
	<link rel="stylesheet" href="/webgl-spotify-player/style.css" <noscript>
	<link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	<link rel="shortcut icon" href="img/favicon.ico" />
	<script type="text/javascript" src="/webgl-spotify-player/glmatrix.js"></script>
	<script type="text/javascript" src="/webgl-spotify-player/script.js"></script>
</head>

<body class="is-preload">
	<div id="wrapper">
		<div id="bg"></div>
		<div id="overlay"></div>
		<div id="main">

			<!-- Header -->
			<header id="header">
				<h1>Dynamic Rhythm</h1>
				<p>Spotify Visualizer</p>
				<nav>
					<ul>
						<li><a href="/login" class="fa fa-spotify"><span class="label">Spotify</span></a></li>
					</ul>
				</nav>
				<div id="loggedin">
					<button id="playbtn" class="btn btn-default"> Click to toggle play/pause</button>
					<button id="spotify:user:coochiemama:playlist:59qIYupKIzuB2L4VD1HqsL" class="btn btn-default" ondblclick="changePlaylist(this)">
						Cool</button>
					<button id="spotify:user:coochiemama:playlist:03CAw5ZsKYSUKD0s9FvkP4" class="btn btn-default" ondblclick="changePlaylist(this)">
						New Patio</button>
					<button id="spotify:user:officialcherub:playlist:3aV55eWHmEycyBdcQwWgt5" class="btn btn-default" ondblclick="changePlaylist(this)">
						Cherub</button>
					<button id="spotify:user:spotify:playlist:37i9dQZF1DXchOWDSVJZqj" class="btn btn-default" ondblclick="changePlaylist(this)">
						1975</button>
					<img id="current-track" height="50px" width="50px" />
					<h3 id="current-track-name"></h3>
					<div id="user-profile">
					</div>
					<div id="oauth">
					</div>
					<button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
				</div>
			</header>

			<script id="user-profile-template" type="text/x-handlebars-template">
				<h1>Logged in as {{display_name}}</h1>
				<div class="media">
				  <div class="pull-left">
					<img class="media-object" width="150" src="{{images.0.url}}" />
				  </div>
				  <div class="media-body">
					<dl class="dl-horizontal">
					  <!--
					  <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
					  <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
					  <dt>Id</dt><dd>{{id}}</dd>
					  <dt>Email</dt><dd>{{email}}</dd>
					  <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
					  <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
					  <dt>Country</dt><dd>{{country}}</dd>
					  -->
					</dl>
				  </div>
				</div>
			  </script>

			<script id="oauth-template" type="text/x-handlebars-template">
				<!-- 				<h2>oAuth info</h2>
				<dl class="dl-horizontal">
				  <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
				  <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
				</dl> -->
			  </script>

			<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
			<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
			<script src="https://sdk.scdn.co/spotify-player.js"></script>
			<script>
				var access_token;
				var device;
				(function () {

					/**
					 * Obtains parameters from the hash of the URL
					 * @return Object
					 */
					function getHashParams() {
						var hashParams = {};
						var e, r = /([^&;=]+)=?([^&;]*)/g,
							q = window.location.hash.substring(1);
						while (e = r.exec(q)) {
							hashParams[e[1]] = decodeURIComponent(e[2]);
						}
						return hashParams;
					}

					var userProfileSource = document.getElementById('user-profile-template').innerHTML,
						userProfileTemplate = Handlebars.compile(userProfileSource),
						userProfilePlaceholder = document.getElementById('user-profile');

					var oauthSource = document.getElementById('oauth-template').innerHTML,
						oauthTemplate = Handlebars.compile(oauthSource),
						oauthPlaceholder = document.getElementById('oauth');

					var params = getHashParams();

					access_token = params.access_token;
					var refresh_token = params.refresh_token,
						error = params.error;

					if (error) {
						alert('There was an error during the authentication');
					} else {
						if (access_token) {
							// render oauth info
							oauthPlaceholder.innerHTML = oauthTemplate({
								access_token: access_token,
								refresh_token: refresh_token
							});

							$.ajax({
								url: 'https://api.spotify.com/v1/me',
								headers: {
									'Authorization': 'Bearer ' + access_token
								},
								success: function (response) {
									userProfilePlaceholder.innerHTML = userProfileTemplate(response);

									$('#login').hide();
									$('#loggedin').show();
								}
							});
							let _token = access_token;

							// Set up the Web Playback SDK

							window.onSpotifyPlayerAPIReady = () => {
								const player = new Spotify.Player({
									name: 'Web Playback SDK Template',
									getOAuthToken: cb => {
										cb(_token);
									}
								});

								player.on('playback_error', e => console.error(e));

								// Playback status updates
								player.on('player_state_changed', state => {
									console.log(state)
									$('#current-track').attr('src', state.track_window.current_track.album.images[0].url);
									$('#current-track-name').text(state.track_window.current_track.name);
								});

								// Ready
								player.on('ready', data => {
									console.log('Ready with Device ID', data.device_id);
									// Play a track using our new device ID
									device = data.device_id;
									console.log(device);
									play(data.device_id, "spotify:playlist:5LMpJYdYBCZN0uuh8Dnxyp");
								});
								// Connect to the player!
								player.connect();
								document.getElementById("playbtn").addEventListener("click", function () {
									player.togglePlay();
								});
							}
							// Play a specified track on the Web Playback SDK's device ID
							function play(device_id, uri) {
								console.log(uri);
								dataString = '{"context_uri":"' + uri + '","position_ms":0}';
								$.ajax({
									url: "https://api.spotify.com/v1/me/player/play?device_id=" + device_id,
									type: "PUT",
									data: dataString,
									beforeSend: function (xhr) {
										xhr.setRequestHeader('Authorization', 'Bearer ' + _token);
									},
									success: function (data) {
										//console.log(data)
									}
								});
							}
						} else {
							// render initial screen
							$('#login').show();
							$('#loggedin').hide();
						}

						document.getElementById('obtain-new-token').addEventListener('click', function () {
							$.ajax({
								url: '/refresh_token',
								data: {
									'refresh_token': refresh_token
								}
							}).done(function (data) {
								access_token = data.access_token;
								oauthPlaceholder.innerHTML = oauthTemplate({
									access_token: access_token,
									refresh_token: refresh_token
								});
							});
						}, false);
					}
				})();

				function changePlaylist(elem) {
					console.log(elem);
					uri = elem.id;
					dataString = '{"context_uri":"' + uri + '","position_ms":0}';
					$.ajax({
						url: "https://api.spotify.com/v1/me/player/play?device_id=" + device,
						type: "PUT",
						data: dataString,
						beforeSend: function (xhr) {
							xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
						},
						success: function (data) {
							console.log(data)
						}
					});
				}
			</script>

			<!-- Footer -->
			<footer id="footer">
				<div class="transposition" id="transposition">
					<div class="fill" id="trackpositionfill"></div>
				</div>
				<nav>
					<ul>
						<li><a href="https://github.com/sofielange98/DynamicRhythm" class="fa fa-github"><span class="label"></span></a></li>
						<li><a href="https://github.com/possan/webgl-spotify-connect-now-playing-screen-example"><span class="label">WebGL
									Spotify Visualizer</span></a></li>
					</ul>
				</nav>
			</footer>

		</div>
	</div>
	<canvas id="canvas" style="border: none; width:20%; height:20%;" width="1200" height="800"></canvas><br />
	<div id="toast" class="toast"><span id="text"></span><span id="text2"></span></div>
	<script>
		window.onload = function () {
			document.body.classList.remove('is-preload');
		}
		window.ontouchmove = function () {
			return false;
		}
		window.onorientationchange = function () {
			document.body.scrollTop = 0;
		}
	</script>
	<script>
		(function (i, s, o, g, r, a, m) {
			i['GoogleAnalyticsObject'] = r;
			i[r] = i[r] || function () {
				(i[r].q = i[r].q || []).push(arguments)
			}, i[r].l = 1 * new Date();
			a = s.createElement(o),
				m = s.getElementsByTagName(o)[0];
			a.async = 1;
			a.src = g;
			m.parentNode.insertBefore(a, m)
		})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
		ga('create', 'UA-49750240-1', 'auto');
		ga('send', 'pageview');
	</script>
</body>

</html>
